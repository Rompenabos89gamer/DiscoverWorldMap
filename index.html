<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piedra Sheikah</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="manifest" href="manifest.json">
    
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Palatino', serif; user-select: none; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }

        .leaflet-tile-pane {
            filter: sepia(100%) contrast(1.1) brightness(0.8) hue-rotate(330deg);
        }

        #fogCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; opacity: 0.92;
        }

        /* --- MARCADOR FLECHA ZELDA --- */
        .zelda-arrow {
            width: 0; height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 25px solid #ffeb3b; 
            filter: drop-shadow(0 0 5px #00f2ff); 
            position: relative;
        }

        .zelda-arrow::after {
            content: ''; position: absolute;
            top: 15px; left: -6px;
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #00f2ff; 
            opacity: 0.8;
        }

        .ui-panel {
            position: absolute; top: env(safe-area-inset-top, 10px); left: 10px; z-index: 10;
            background: rgba(10, 20, 30, 0.8);
            color: #e6d6ad; padding: 12px;
            border: 2px solid #e6d6ad; border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); min-width: 150px;
        }

        .percentage-container {
            font-size: 24px; font-weight: bold; color: #00f2ff;
            text-shadow: 0 0 10px #00f2ff;
        }

        .label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* Botons d'acci√≥ */
        .btn-group {
            position: absolute; bottom: 30px; right: 20px; z-index: 10;
            display: flex; flex-direction: column; gap: 10px;
        }

        .sheikah-btn {
            background: rgba(0, 0, 0, 0.7); color: #00f2ff; 
            border: 1px solid #00f2ff; padding: 10px; 
            border-radius: 50%; width: 50px; height: 50px;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
            cursor: pointer;
        }
        
        /* PANTALLA MODE BUTXACA (Estalvi de bateria) */
        #pocket-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999;
            color: #333; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        
        #pocket-overlay.active { display: flex; }
        
        .saver-icon { font-size: 50px; opacity: 0.3; margin-bottom: 20px; }
        .saver-text { font-family: monospace; opacity: 0.3; }

    </style>
</head>
<body>

    <div id="map"></div>
    <canvas id="fogCanvas"></canvas>
    
    <div class="ui-panel">
        <div class="label">Exploraci√≥n del Mundo</div>
        <div id="percentage" class="percentage-container">0.0000%</div>
        <div id="status" style="font-size: 12px; margin-top: 5px;">Sincronizando...</div>
    </div>

    <div class="btn-group">
        <button class="sheikah-btn" onclick="togglePocketMode()">üîí</button>
        <button class="sheikah-btn" onclick="resetProgress()" style="color:red; border-color:red;">‚úï</button>
    </div>

    <div id="pocket-overlay" ondblclick="togglePocketMode()">
        <div class="saver-icon">üõ°Ô∏è</div>
        <div class="saver-text">MODE BUTXACA ACTIVAT<br>Doble clic per desbloquejar<br>GPS Actiu</div>
    </div>

    <script>
        const canvas = document.getElementById('fogCanvas');
        const ctx = canvas.getContext('2d');
        const percentDisplay = document.getElementById('percentage');
        const statusDisplay = document.getElementById('status');
        const pocketOverlay = document.getElementById('pocket-overlay');

        // WAKE LOCK (Mantenir pantalla encesa)
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Pantalla bloquejada encesa');
            } catch (err) {
                console.log(`${err.name}, ${err.message}`);
            }
        }
        
        // Reactivar Wake Lock si minimitzes i tornes
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });
        requestWakeLock(); // Demanar al iniciar

        // Mode Butxaca Logic
        function togglePocketMode() {
            pocketOverlay.classList.toggle('active');
            if(pocketOverlay.classList.contains('active')){
                // Baixar brillantor (simulat) i bloquejar
                requestWakeLock();
            }
        }

        // --- L√íGICA MAPA I GPS (Igual que abans) ---
        let visitedPoints = JSON.parse(localStorage.getItem('zelda_map_progress')) || [];
        let uniqueSectors = new Set();
        var userMarker = null;

        visitedPoints.forEach(point => { addSector(point.lat, point.lng); });
        calculatePercentage(); 

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawFog();
        }

        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0, 0], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function getRadiusPx() {
            const zoom = map.getZoom();
            return Math.pow(2, zoom - 16) * 100;
        }

        function drawFog() {
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'destination-out';
            ctx.shadowBlur = 30; ctx.shadowColor = 'black';
            const radius = getRadiusPx();
            const bounds = map.getBounds().pad(0.2);
            visitedPoints.forEach(point => {
                const latLng = L.latLng(point.lat, point.lng);
                if (bounds.contains(latLng)) { 
                    const screenPos = map.latLngToContainerPoint(latLng);
                    ctx.beginPath(); ctx.arc(screenPos.x, screenPos.y, radius, 0, Math.PI * 2); ctx.fill();
                }
            });
        }

        function addSector(lat, lng) {
            const sectorID = lat.toFixed(3) + "_" + lng.toFixed(3);
            uniqueSectors.add(sectorID);
        }

        function calculatePercentage() {
            const areaPerSector = 0.012; const worldArea = 510072000; 
            let totalExplored = uniqueSectors.size * areaPerSector;
            let percent = (totalExplored / worldArea) * 100;
            percentDisplay.innerText = percent.toFixed(7) + "%";
        }

        map.locate({watch: true, enableHighAccuracy: true});

        map.on('locationfound', (e) => {
            const newPos = {lat: e.latlng.lat, lng: e.latlng.lng};
            const heading = (e.heading !== null) ? e.heading : 0;
            const arrowIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="zelda-arrow" style="transform: rotate(${heading}deg);"></div>`,
                iconSize: [20, 25], iconAnchor: [10, 12]
            });

            if (!userMarker) {
                userMarker = L.marker(e.latlng, {icon: arrowIcon}).addTo(map);
            } else {
                userMarker.setLatLng(e.latlng); userMarker.setIcon(arrowIcon);
            }

            if (visitedPoints.length === 0 || e.latlng.distanceTo(visitedPoints[visitedPoints.length-1]) > 15) {
                visitedPoints.push(newPos);
                addSector(e.latlng.lat, e.latlng.lng);
                calculatePercentage();
                localStorage.setItem('zelda_map_progress', JSON.stringify(visitedPoints));
                statusDisplay.innerText = "Sincronizado";
            }
            map.panTo(e.latlng);
            drawFog();
        });

        function resetProgress() {
            if(confirm("¬øBorrar progreso?")) {
                visitedPoints = []; uniqueSectors.clear();
                localStorage.removeItem('zelda_map_progress'); location.reload();
            }
        }
        map.on('move', drawFog); window.addEventListener('resize', resize); resize();
    </script>
    
    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(regs) { for(let reg of regs) { reg.update(); } });
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('https://cdn.jsdelivr.net/npm/pwacompat@2.0.9/pwacompat.min.js');
      });
    }
    </script>
</body>
</html>
