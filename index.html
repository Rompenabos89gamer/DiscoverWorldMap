<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piedra Sheikah</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="manifest" href="manifest.json">
    
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Palatino', serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }

        .leaflet-tile-pane {
            filter: sepia(100%) contrast(1.1) brightness(0.8) hue-rotate(330deg);
        }

        #fogCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; opacity: 0.92;
        }

                .zelda-arrow {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 25px solid #ffeb3b; /* Cuerpo Amarillo */
            filter: drop-shadow(0 0 5px #00f2ff); /* Brillo Sheikah */
            position: relative;
        }

        /* El detalle azul pequeño en la base, rotado correctamente */
        .zelda-arrow::after {
            content: '';
            position: absolute;
            top: 15px; /* Posicionado dentro de la flecha amarilla */
            left: -6px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #00f2ff; /* Triángulo azul apuntando hacia abajo */
            opacity: 0.8;
        }

        /* El triángulo que hace el recorte en la base */
        .zelda-arrow::after {
            content: '';
            position: absolute;
            top: 18px; /* Ajustado para que encaje en la base */
            left: -12px;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 10px solid #000; /* Color del fondo para "recortar" */
        }

        .ui-panel {
            position: absolute; top: env(safe-area-inset-top, 10px); left: 10px; z-index: 10;
            background: rgba(10, 20, 30, 0.8);
            color: #e6d6ad; padding: 12px;
            border: 2px solid #e6d6ad; border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); min-width: 150px;
        }

        .percentage-container {
            font-size: 24px; font-weight: bold; color: #00f2ff;
            text-shadow: 0 0 10px #00f2ff;
        }

        .label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        #reset-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 10;
            background: rgba(200, 0, 0, 0.5); color: white; border: 1px solid white;
            padding: 5px; font-size: 10px; border-radius: 50%; width: 40px; height: 40px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <canvas id="fogCanvas"></canvas>
    
    <div class="ui-panel">
        <div class="label">Exploración del Mundo</div>
        <div id="percentage" class="percentage-container">0.0000%</div>
        <div id="status" style="font-size: 12px; margin-top: 5px;">Sincronizando...</div>
    </div>

    <button id="reset-btn" onclick="resetProgress()">RESET</button>

    <script>
        const canvas = document.getElementById('fogCanvas');
        const ctx = canvas.getContext('2d');
        const percentDisplay = document.getElementById('percentage');
        const statusDisplay = document.getElementById('status');

        let visitedPoints = JSON.parse(localStorage.getItem('zelda_map_progress')) || [];
        var userMarker = null;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawFog();
        }

        // Configurar Mapa
        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0, 0], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function getRadiusPx() {
            const zoom = map.getZoom();
            return Math.pow(2, zoom - 16) * 100;
        }

        function drawFog() {
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.globalCompositeOperation = 'destination-out';
            ctx.shadowBlur = 30;
            ctx.shadowColor = 'black';

            const radius = getRadiusPx();
            visitedPoints.forEach(point => {
                const latLng = L.latLng(point.lat, point.lng);
                if (map.getBounds().pad(0.2).contains(latLng)) { 
                    const screenPos = map.latLngToContainerPoint(latLng);
                    ctx.beginPath();
                    ctx.arc(screenPos.x, screenPos.y, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            calculatePercentage();
        }

        function calculatePercentage() {
            const areaPerPoint = 0.0314; 
            const worldArea = 510072000; 
            let totalExplored = visitedPoints.length * areaPerPoint;
            let percent = (totalExplored / worldArea) * 100;
            percentDisplay.innerText = percent.toFixed(7) + "%";
        }

        // GPS Y FLECHA
        map.locate({watch: true, enableHighAccuracy: true});

        map.on('locationfound', (e) => {
            const newPos = {lat: e.latlng.lat, lng: e.latlng.lng};
            
            // Actualizar o crear la flecha
            const heading = e.heading || 0; // Rotación según el GPS
            const arrowIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="zelda-arrow" style="transform: rotate(${heading}deg);"></div>`,
                iconSize: [20, 25],
                iconAnchor: [10, 12]
            });

            if (!userMarker) {
                userMarker = L.marker(e.latlng, {icon: arrowIcon}).addTo(map);
            } else {
                userMarker.setLatLng(e.latlng);
                userMarker.setIcon(arrowIcon);
            }

            // Guardar progreso
            if (visitedPoints.length === 0 || e.latlng.distanceTo(visitedPoints[visitedPoints.length-1]) > 15) {
                visitedPoints.push(newPos);
                localStorage.setItem('zelda_map_progress', JSON.stringify(visitedPoints));
                statusDisplay.innerText = "Ubicación actualizada";
            }

            map.panTo(e.latlng);
            drawFog();
        });

        function resetProgress() {
            if(confirm("¿Borrar progreso?")) {
                visitedPoints = [];
                localStorage.removeItem('zelda_map_progress');
                location.reload();
            }
        }

        map.on('move', drawFog);
        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
